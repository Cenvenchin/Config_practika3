# Ассемблер и интерпретатор для учебной виртуальной машины (УВМ)

Проект реализует ассемблер и интерпретатор для учебной виртуальной машины согласно спецификации.

## Структура проекта

```
config_practika3/
├── assembler/          # Модуль ассемблера
│   ├── __init__.py
│   ├── cli.py          # CLI интерфейс ассемблера
│   ├── parser.py       # Парсер YAML файлов
│   ├── translator.py   # Транслятор в промежуточное представление
│   └── codegen.py      # Генератор машинного кода
├── interpreter/        # Модуль интерпретатора
│   ├── __init__.py
│   ├── cli.py          # CLI интерфейс интерпретатора
│   ├── cpu.py          # CPU интерпретатора
│   ├── instructions.py # Реализация инструкций
│   └── memory.py       # Модель памяти УВМ
├── examples/           # Примеры программ на языке ассемблера
│   ├── test_load_constant.yaml
│   ├── test_memory_read_write.yaml
│   ├── test_bswap.yaml
│   ├── test_vector_operations.yaml
│   └── test_array_copy.yaml
├── tests/              # Тесты
│   ├── test1.py
│   ├── test2.py
│   ├── test3.py
│   └── test4.py
├── output/             # Выходные файлы
├── requirements.txt
└── Readme.md
```

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Язык ассемблера

Язык ассемблера использует формат YAML. Программа представляет собой список инструкций.

### Формат программы

```yaml
instructions:
  - opcode: <название_команды>
    <параметры>
```

### Поддерживаемые команды

#### 1. load_const - Загрузка константы

Загружает константу в регистр.

**Параметры:**
- `address` (int): Адрес регистра для записи результата (0-127)
- `constant` (int): Константа для загрузки (32-битное значение)

**Пример:**
```yaml
- opcode: load_const
  address: 124
  constant: 828
```

**Размер команды:** 5 байт

#### 2. read_mem - Чтение значения из памяти

Читает значение из памяти по адресу, указанному в регистре, и записывает в другой регистр.

**Параметры:**
- `result_addr` (int): Адрес регистра для записи результата (0-127)
- `source_addr` (int): Адрес регистра, содержащего адрес источника в памяти (0-127)

**Пример:**
```yaml
- opcode: read_mem
  result_addr: 116
  source_addr: 68
```

**Размер команды:** 3 байта

#### 3. write_mem - Запись значения в память

Записывает значение из регистра в память по адресу, указанному в другом регистре.

**Параметры:**
- `source_addr` (int): Адрес регистра с данными для записи (0-127)
- `result_addr` (int): Адрес регистра, содержащего адрес назначения в памяти (0-127)

**Пример:**
```yaml
- opcode: write_mem
  source_addr: 56
  result_addr: 49
```

**Размер команды:** 3 байта

#### 4. bswap - Унарная операция обращения байтов

Выполняет операцию обращения байтов (bswap) над значением в памяти и записывает результат в память.

**Параметры:**
- `result_addr` (int): Адрес регистра с базовым адресом результата (0-127)
- `result_offset` (int): Смещение для адреса результата
- `operand_offset` (int): Смещение для адреса операнда
- `operand_addr` (int): Адрес регистра с базовым адресом операнда (0-127)

**Пример:**
```yaml
- opcode: bswap
  result_addr: 82
  result_offset: 796
  operand_offset: 735
  operand_addr: 5
```

**Размер команды:** 6 байт

**Операция bswap:**
Преобразует 32-битное значение из формата little-endian в big-endian (и наоборот), обращая порядок байтов:
- `0x12345678` → `0x78563412`

## Использование

### Ассемблер

Ассемблирует YAML файл в бинарный файл:

```bash
python -m assembler.cli <входной_yaml> <выходной_bin> [--test]
```

**Параметры:**
- `входной_yaml`: Путь к исходному YAML файлу
- `выходной_bin`: Путь к выходному бинарному файлу
- `--test`: Режим тестирования (выводит промежуточное представление и байты)

**Пример:**
```bash
python -m assembler.cli examples/test_load_constant.yaml output/test.bin --test
```

### Интерпретатор

Выполняет бинарную программу и создает дамп памяти:

```bash
python -m interpreter.cli <программа_bin> <дамп_xml> [--start ADDR] [--end ADDR]
```

**Параметры:**
- `программа_bin`: Путь к бинарному файлу программы
- `дамп_xml`: Путь к файлу для сохранения дампа памяти
- `--start`: Начальный адрес для дампа (по умолчанию: 0)
- `--end`: Конечный адрес для дампа (по умолчанию: 1024)

**Пример:**
```bash
python -m interpreter.cli output/test.bin output/memory.xml --start 0 --end 1024
```

## Тестирование

Запуск тестов:

```bash
python tests/test1.py  # Тест load_const
python tests/test2.py  # Тест read_mem
python tests/test3.py  # Тест write_mem
python tests/test4.py  # Тест bswap
```

## Примеры программ

### Пример 1: Копирование массива

Программа копирует массив из одного адреса памяти в другой:

```bash
python -m assembler.cli examples/test_array_copy.yaml output/array_copy.bin
python -m interpreter.cli output/array_copy.bin output/array_copy_memory.xml
```

### Пример 2: Операция bswap над вектором

Программа выполняет поэлементно операцию bswap над вектором длины 6:

```bash
python -m assembler.cli examples/test_vector_operations.yaml output/vector.bin
python -m interpreter.cli output/vector.bin output/vector_memory.xml
```

## Формат дампа памяти

Дамп памяти сохраняется в формате XML:

```xml
<?xml version='1.0' encoding='utf-8'?>
<memory_dump start="0" end="1024">
  <entry address="0x0000" value="0x12345678">305419896</entry>
  <entry address="0x0004" value="0xABCDEF00">2882400000</entry>
  ...
</memory_dump>
```

## Архитектура УВМ

### Память

- Объединенная память команд и данных
- Размер: 65536 байт (64 KB)
- Адресация: байтовая
- Формат данных: 32-битные слова (little-endian)

### Регистры

- Количество: 128 регистров
- Адреса: 0-127
- Размер: 32 бита каждый
- Использование: хранение адресов и промежуточных значений

### Инструкции

Все инструкции кодируются в бинарном формате с фиксированными размерами:
- `load_const`: 5 байт
- `read_mem`: 3 байта
- `write_mem`: 3 байта
- `bswap`: 6 байт

## Этапы реализации

### Этап 1: Перевод программы в промежуточное представление ✓
- Реализован парсер YAML
- Реализован транслятор в промежуточное представление
- Реализован режим тестирования с выводом промежуточного представления

### Этап 2: Формирование машинного кода ✓
- Реализован генератор машинного кода
- Реализована запись результата в бинарный файл
- Реализован режим тестирования с выводом байтов

### Этап 3: Интерпретатор и операции с памятью ✓
- Реализована модель памяти УВМ
- Реализован основной цикл интерпретации
- Реализованы команды загрузки константы, чтения и записи в память
- Реализован формат XML для дампа памяти

### Этап 4: Реализация АЛУ ✓
- Реализована команда bswap()
- Созданы тестовые программы для проверки корректности

### Этап 5: Выполнение тестовой задачи ✓
- Реализована программа для поэлементного выполнения bswap над вектором
- Созданы примеры программ с вычислениями
- Продемонстрирована работа дампа памяти

## Автор

Проект выполнен в рамках практической работы по конфигурированию программного обеспечения.

